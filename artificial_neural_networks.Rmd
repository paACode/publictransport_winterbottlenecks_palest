---
title: "First tries with Artificial Neural Networks"
author: "Pascal Ackermann"
date: "21.03.2025"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading the Packages

For this example we use the `nnet` package (and `gamlss.add` to plot these networks) and `ggplot2` to create some plots.

```{r}
library(nnet)
library(gamlss.add)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())
```

And we also need the `caret` package for some helper functions

```{r}
library(caret)
```

## Loading the Data

```{r}
d.zentralbahn <- read.csv("zentrahlbahn_nov_dataset_delay.csv", sep =",", head=TRUE )
```

## A first look at the Data "Ausfälle"

[]

Looks like i the beginning and end of november there are a bit less "Ausfälle".
Also what we can see is that there is a periodic behaviour ( Saturdays and Sundays). Because at weekends there are less trains. The sudden change of less Ausfälle could be related to the following link:

https://www.zentralbahn.ch/de/kennenlernen/die-zentralbahn/einblicke/wiedereroeffnung-der-strecke-meiringen-interlaken-ost-am-25-november-2024


```{r}
d.zentralbahn %>%
  ggplot(aes(x = BETRIEBSTAG, fill = FAELLT_AUS_TF)) +
  geom_histogram(stat = "count",position = "dodge")
```

 In this plot we can clearly see that R70 and R71 "Fallen aus" more than they arriv on time. This is also very likely related to the Link of the Strecke Meiringe-Interlaken Ost
```{r}
d.zentralbahn %>%
  ggplot(aes(x = LINIEN_TEXT, fill = FAELLT_AUS_TF)) +
  geom_histogram(stat = "count",position = "dodge")
```


![Data Visualization](Streckennetz_Zentralbahn.png)



# Prepare the Data

Split the data into 80% to train and 20% to test.

```{r}
d.zentralbahn_for_ann <- d.zentralbahn %>%
  select(FAELLT_AUS_TF, LINIEN_TEXT) # Want to predict Faellt aus based on Linien ID

#Needs to be factor for ann to work
d.zentralbahn_for_ann$FAELLT_AUS_TF <-  as.factor(d.zentralbahn_for_ann$FAELLT_AUS_TF)

#Create Dummy Variables for training
dummies <- dummyVars(~LINIEN_TEXT, data = d.zentralbahn_for_ann)
data_dummies <- predict(dummies, newdata = d.zentralbahn_for_ann)

#Remove original Linien ID and add data_dummies
d.zentralbahn_for_ann <- d.zentralbahn_for_ann %>% 
  select(-LINIEN_TEXT) 
  
# add data_dummies for Linien _TEXT
d.zentralbahn_for_ann <- bind_cols(d.zentralbahn_for_ann, data_dummies)
  
  


```

```{r}
set.seed(123)
is_train <- runif(nrow(d.zentralbahn_for_ann)) < 0.8
mean(is_train)
```
```{r}
train <- d.zentralbahn_for_ann[is_train, ]
test <- d.zentralbahn_for_ann[!is_train, ]
```


## Build the network

```{r}
set.seed(412)
fealltaus_net <- nnet(FAELLT_AUS_TF ~ . , data = train, size=16, maxit=10000, range=0.1, decay=5e-4, MaxNWts = 2000)
```

```{r}
plot(fealltaus_net)
```
```{r}
pred <- predict(fealltaus_net, test, type="class")
cm_nn <- table(pred=pred, true=test$FAELLT_AUS_TF)
cm_nn

confusionMatrix(as.factor(pred), as.factor(test$FAELLT_AUS_TF))
```