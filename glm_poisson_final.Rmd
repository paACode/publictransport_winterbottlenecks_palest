---
title: "GLM Poisson"
subtitle: "[Public GitHub Repository](https://github.com/paACode/publictransport_winterbottlenecks_palest)"
author:  "Pascal"
date: "05.04.2025"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
  pdf_document:
    toc: true
    toc_depth: '3'
---

```{r, echo=FALSE , include=FALSE}
## Document related Settings and Libs
require(knitr) 
require(details)    # allows collapsible code blocks
require(gt)         # formats tables nicely

## general language settings
Sys.setenv(LANG = "en")

## Default Settings for R-Chunks
opts_chunk$set(echo = FALSE ,
               include = FALSE,
               comment = NA,
               eval = TRUE,
               message = FALSE,
               warning = FALSE)
```


```{r Import Data and Create Subset for GLM Poisson}

library(dplyr)
library(ggplot2)
library(tidyr)
library(forcats) 
library(lubridate)

#### Read in Data ####----------------------------------------------------------
d.poisson<- read.csv("zentrahlbahn_final.csv") %>% 
  select(BETRIEBSTAG, LINIEN_TEXT, HALTESTELLEN_NAME, ANKUNFTSZEIT, AN_PROGNOSE,
         ANKUNFTDELAY_sec, ABFAHRTSZEIT, AB_PROGNOSE, ABFAHRTDELAY_sec,FAELLT_AUS_TF,
         Delay_Category, TAGESZEIT, RUSH_HOUR, w_precip_mm_Luzern, w_temp_min_c_Luzern, w_temp_avg_c_Luzern)
```


```{r Add operating hour, include=TRUE}

### First of all we add a categorical variable for every hour per day --> in total 24 categories

d.poisson <-  d.poisson %>% 
  mutate(
    hour = hour(as.POSIXct(ANKUNFTSZEIT, format="%Y-%m-%d %H:%M:%S")), 
    operating_hour = factor(
      paste0(hour, ":00 - ", hour + 1, ":00"),
      levels = paste0(0:23, ":00 - ", 1:24, ":00")
    )
  )
```

```{r Only consider Abfahrtsz端ge, include=TRUE}

### First of all we add a categorical variable for every hour per day --> in total 24 categories

d.poisson <-  d.poisson %>% 
  filter(!is.na(operating_hour))  # Removes NA observations --> This are the Abfahrtsz端ge
```
  

```{r Create Subsed for Delayed Train, include=FALSE}

d.poisson.agg.day.oh <- d.poisson %>%
  group_by(operating_hour, BETRIEBSTAG) %>% # Aggregate data by operating hour and delay 
  summarize(Count_Delayed = sum(Delay_Category != "On Time"), .groups = "drop") %>% # Only consider delayed trains
  ungroup()

```
# Poisson Model

## Overview

The goal of this model is to predict the number of delayed trains based on several predictors. The number of delayed trains is aggregated to "operating hour" and "operation day". This means:

 - there are 30 observatios per "operating hour" because the dataset contains the month november, which has 30 days.
 - there are 22 observations per "operating day" because there are in total 23 operating hours , and between 1am and 2am there is no operation


Since the response variable is a count-variable, we expect it to exhibit right skewness and increasing variance as the count increases.

Plotting the data reveals that indeed the count-variable is right-skewed.

```{r Hist Skewed, include=TRUE}
par(mfrow=c(1,2))
hist(d.poisson.agg.day.oh$Count_Delayed, breaks = 20, main= "Original", xlab = "Count 'Delayed Trains '")
hist(log1p(d.poisson.agg.day.oh$Count_Delayed), breaks=20, main = "Log Transformed ", xlab = "Count 'Delayed Trains'")

```

The quartile boxplot does not support the assumption that the variance increases linearly with the mean. This suggests that the count variable may not follow a Poisson distribution. This is an initial indication that the GLM should be fitted with a quasipoisson family to account for overdispersion.

```{r Overdispersion, include=TRUE}
quantile_groups <- cut(d.poisson.agg.day.oh$Count_Delayed, breaks=quantile(d.poisson.agg.day.oh$Count_Delayed), 
                       include.lowest=TRUE, labels=c("Q1", "Q2", "Q3", "Q4"))

boxplot(d.poisson.agg.day.oh$Count_Delayed ~quantile_groups)

```


## Finding reasonable Predictors "Operation Category"

Having a predictor operating hour with 24 levels makes the interpretation of the model quite complicated. 
Therfore a first visual analisi of the data should give an idea if the predictor "operating-hour" can be simplified.



```{r Overdispersion, include=TRUE}
ggplot(d.poisson.agg.day.oh, aes(x =  operating_hour, 
                           y = Count_Delayed)) +
  geom_boxplot() +
   geom_jitter(width = 0.2, height = 0.1, color = "blue", alpha = 0.2)+
  labs(title = "Delayed Trains Count", 
       x = "Operating Hour", 
       y = "Nr of Observations that were Delayed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



```


![Rush Hour Image](Rush_Hours.png)



Indeed there seems to be a pattern in "operation hour" which can be simplified by "operation category" with 3 levels:

 - Low Operation : (0:00 until 6:00)
 - Rush Hour : (6:00 until 9:00) and (11:00 until 14:00) and (16:00 until 20:00)
 - Normal Operation : Everything else

```{r Add Operation Category, include=TRUE}

d.poisson <- d.poisson %>%
  mutate(
    ANKUNFTSZEIT = as.POSIXct(ANKUNFTSZEIT, format="%Y-%m-%d %H:%M:%S"),
    operation_category = case_when(
      (hour(ANKUNFTSZEIT) >= 0 & hour(ANKUNFTSZEIT) < 2)|
      (hour(ANKUNFTSZEIT) >= 4 & hour(ANKUNFTSZEIT) < 5) ~ "Low Operation",    # 0am to 6am
      (hour(ANKUNFTSZEIT) >= 6 & hour(ANKUNFTSZEIT) < 9) |  # 6am to 9am
        (hour(ANKUNFTSZEIT) >= 11 & hour(ANKUNFTSZEIT) < 14) | # 11am to 2pm
        (hour(ANKUNFTSZEIT) >= 16 & hour(ANKUNFTSZEIT) < 20) ~ "Rush Hour", # 4pm to 8pm
      TRUE ~ "Normal Operation"   # Everything else
    )
  )

#Create A subset aggregating by operation day and Category
d.poisson.agg.day.oc <- d.poisson %>%
  filter(!is.na(operating_hour)) %>%  # Removes NA observations --> This are the Abfahrtsz端ge
  group_by(operation_category, BETRIEBSTAG) %>%
  summarize(Count_Delayed = sum(Delay_Category != "On Time"), .groups = "drop") %>% 
  ungroup()

ggplot(d.poisson.agg.day.oc, aes(x = operation_category , 
                           y = Count_Delayed)) +
  geom_boxplot() +
   geom_jitter(width = 0.2, height = 0.01, color = "blue", alpha = 0.2)+
  labs(title = "Delayed Trains Count", 
       x = "Operation Category", 
       y = "Nr of Observations that were Delayed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


With Anova and Multiple Comparison it can be confirmed what is already clear by visualizing the Boxplot. 
- Anova: At least one of the 3 Levels differs significantly.
- Multiple Comparison: All the 3 Levels differ significantly


```{r GLM Poisson: Influence of Operating Hour, include=TRUE}
library(multcomp)
d.poisson.agg.day.oc$operation_category <- as.factor(d.poisson.agg.day.oc$operation_category)
anova_model <- aov(Count_Delayed ~operation_category, data = d.poisson.agg.day.oc)
summary(anova_model)  # Overall ANOVA table

mc <- glht(anova_model, linfct = mcp(operation_category = "Tukey"))
summary(mc)
```



## Finding reasonable Predictors "Event Category"

Creating a level for each Day in November does not make sense. Therefore data are again visualized to see if there are any patterns so that
predictor can be simplified.

Here it would make sense to create the following 3 Levels:

-  Extreme Days: 22.11 and 23.11
-  Meiringen Reopened : After 25.11
-  Normal Operation


```{r Look at Days, include=TRUE}

ggplot(mapping = aes(y = d.poisson.agg.day.oh$Count_Delayed,
x = d.poisson.agg.day.oh$BETRIEBSTAG)) +
  geom_boxplot() + 
  geom_hline(yintercept = 0) + 
  geom_jitter(width = 0.5, height = 0.3, color = "blue", alpha = 0.2)+
  labs(title = "Delayed Trains Count", 
       x = "Operating Hour", 
       y = "Simulated Observations that were Delayed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```


```{r Add Day Category, include=TRUE}

d.poisson <- d.poisson %>%
  mutate(
    day_category = case_when(
      (BETRIEBSTAG == "2024-11-21") |
      (BETRIEBSTAG == "2024-11-22") ~ "Extreme Days",   
      (as.Date(BETRIEBSTAG) >= "2024-11-25")  ~ "Meiringen Reopened", # 4pm to 8pm
      TRUE ~ "Normal Operation"   # Everything else
    )
  )

#Create A subset aggregating by operation day and day category
d.poisson.agg.day.dc <- d.poisson %>%
  filter(!is.na(operating_hour)) %>%  # Removes NA observations --> This are the Abfahrtsz端ge
  group_by(day_category,operating_hour) %>%
  summarize(Count_Delayed = sum(Delay_Category != "On Time"), .groups = "drop") %>% 
  group_by(day_category) %>%  # Group by day_category to get the total for each category
  mutate(Count_Delayed_Norm = Count_Delayed / sum(Count_Delayed)) %>%  # Normalize by total Count_Delayed within each day_category
  ungroup()  # Ungroup after mutation


ggplot(d.poisson.agg.day.dc, aes(x = day_category , 
                           y = Count_Delayed_Norm)) +
  geom_boxplot() +
   geom_jitter(width = 0.2, height = 0.01, color = "blue", alpha = 0.2)+
  labs(title = "Delayed Trains Count", 
       x = "Operation Category", 
       y = "Nr of Observations that were Delayed per Day") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```