---
title: "GLM Poisson"
subtitle: "[Public GitHub Repository](https://github.com/paACode/publictransport_winterbottlenecks_palest)"
author:  "Pascal"
date: "05.04.2025"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
  pdf_document:
    toc: true
    toc_depth: '3'
---

```{r, echo=FALSE , include=FALSE}
## Document related Settings and Libs
require(knitr) 
require(details)    # allows collapsible code blocks
require(gt)         # formats tables nicely

## general language settings
Sys.setenv(LANG = "en")

## Default Settings for R-Chunks
opts_chunk$set(echo = FALSE ,
               include = FALSE,
               comment = NA,
               eval = TRUE,
               message = FALSE,
               warning = FALSE)
```


```{r Import Data and Create Subset for GLM Poisson}

library(dplyr)
library(ggplot2)
library(tidyr)
library(forcats) 
library(lubridate)

#### Read in Data ####----------------------------------------------------------
d.poisson<- read.csv("zentrahlbahn_final.csv") %>% 
  select(BETRIEBSTAG, LINIEN_TEXT, HALTESTELLEN_NAME, ANKUNFTSZEIT, AN_PROGNOSE,
         ANKUNFTDELAY_sec, ABFAHRTSZEIT, AB_PROGNOSE, ABFAHRTDELAY_sec,FAELLT_AUS_TF,
         Delay_Category, TAGESZEIT, RUSH_HOUR, w_precip_mm_Luzern, w_temp_min_c_Luzern, w_temp_avg_c_Luzern)
```


```{r Add operating hour, include=TRUE}

### First of all we add a categorical variable for every hour per day --> in total 24 categories

d.poisson <-  d.poisson %>% 
  mutate(
    hour = hour(as.POSIXct(ANKUNFTSZEIT, format="%Y-%m-%d %H:%M:%S")), 
    operating_hour = factor(
      paste0(hour, ":00 - ", hour + 1, ":00"),
      levels = paste0(0:23, ":00 - ", 1:24, ":00")
    )
  )
```

```{r Only consider Abfahrtszüge, include=TRUE}

### First of all we add a categorical variable for every hour per day --> in total 24 categories

d.poisson <-  d.poisson %>% 
  filter(!is.na(operating_hour))  # Removes NA observations --> This are the Abfahrtszüge
```
  

```{r Create Subsed for Delayed Train, include=FALSE}

d.poisson.agg.day.oh <- d.poisson %>%
  group_by(operating_hour, BETRIEBSTAG) %>% # Aggregate data by operating hour and delay 
  summarize(Count_Delayed = sum(Delay_Category != "On Time"), .groups = "drop") %>% # Only consider delayed trains
  ungroup()

```
# Poisson Model

## Overview

The goal of this model is to predict the number of delayed trains based on several predictors. The number of delayed trains is aggregated to "operating hour" and "operation day". This means:

 - there are 30 observatios per "operating hour" because the dataset contains the month november, which has 30 days.
 - there are 22 observations per "operating day" because there are in total 23 operating hours , and between 1am and 2am there is no operation


Since the response variable is a count-variable, we expect it to exhibit right skewness and increasing variance as the count increases.

Plotting the data reveals that indeed the count-variable is right-skewed.

```{r Hist Skewed, include=TRUE}
par(mfrow=c(1,2))
hist(d.poisson.agg.day.oh$Count_Delayed, breaks = 20, main= "Original", xlab = "Count 'Delayed Trains '")
hist(log1p(d.poisson.agg.day.oh$Count_Delayed), breaks=20, main = "Log Transformed ", xlab = "Count 'Delayed Trains'")

```

The quartile boxplot does not support the assumption that the variance increases linearly with the mean. This suggests that the count variable may not follow a Poisson distribution. This is an initial indication that the GLM should be fitted with a quasipoisson family to account for overdispersion.

```{r Overdispersion, include=TRUE}
quantile_groups <- cut(d.poisson.agg.day.oh$Count_Delayed, breaks=quantile(d.poisson.agg.day.oh$Count_Delayed), 
                       include.lowest=TRUE, labels=c("Q1", "Q2", "Q3", "Q4"))

boxplot(d.poisson.agg.day.oh$Count_Delayed ~quantile_groups)

```


## Finding reasonable Predictors "Operation Category"

Having a predictor operating hour with 24 levels makes the interpretation of the model quite complicated. 
Therfore a first visual analisi of the data should give an idea if the predictor "operating-hour" can be simplified.



```{r Nr of Delay aggregated per Day and Operating Hour, include=TRUE}
ggplot(d.poisson.agg.day.oh, aes(x =  operating_hour, 
                           y = Count_Delayed)) +
  geom_boxplot() +
   geom_jitter(width = 0.2, height = 0.1, color = "blue", alpha = 0.2)+
  labs(title = "Delayed Trains Count", 
       x = "Operating Hour", 
       y = "Nr of Observations that were Delayed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



```


![Rush Hour Image](Rush_Hours.png)



Indeed there seems to be a pattern in "operation hour". In a first step, the "operation- hour" is simplified by "operation category" with 3 levels:

 - Low Operation : (0:00 until 6:00)
 - Rush Hour : (6:00 until 9:00) and (11:00 until 14:00) and (16:00 until 20:00)
 - Normal Operation : Everything else
 
In the boxplot below a direct comparison of delayed train counts across operation categories isn't meaningful, since each category includes a different total number of train arrivals.

```{r Add Operation Category, include=TRUE}

d.poisson <- d.poisson %>%
  mutate(
    ANKUNFTSZEIT = as.POSIXct(ANKUNFTSZEIT, format="%Y-%m-%d %H:%M:%S"),
    operation_category = case_when(
      (hour(ANKUNFTSZEIT) >= 0 & hour(ANKUNFTSZEIT) < 2)|
      (hour(ANKUNFTSZEIT) >= 4 & hour(ANKUNFTSZEIT) < 5) ~ "Low Operation",    # 0am to 6am
      (hour(ANKUNFTSZEIT) >= 6 & hour(ANKUNFTSZEIT) < 9) |  # 6am to 9am
        (hour(ANKUNFTSZEIT) >= 11 & hour(ANKUNFTSZEIT) < 14) | # 11am to 2pm
        (hour(ANKUNFTSZEIT) >= 16 & hour(ANKUNFTSZEIT) < 20) ~ "Rush Hour", # 4pm to 8pm
      TRUE ~ "Normal Operation"   # Everything else
    )
  )

#Create A subset aggregating by operation day and Category
d.poisson.agg.day.oc <- d.poisson %>%
  filter(!is.na(operating_hour)) %>%  # Removes NA observations --> This are the Abfahrtszüge
  group_by(operation_category, BETRIEBSTAG) %>%
  summarize(Count_Delayed = sum(Delay_Category != "On Time"), .groups = "drop") %>% 
  ungroup()

ggplot(d.poisson.agg.day.oc, aes(x = operation_category , 
                           y = Count_Delayed)) +
  geom_boxplot() +
   geom_jitter(width = 0.2, height = 0.01, color = "blue", alpha = 0.2)+
  labs(title = "Delayed Trains Count", 
       x = "Operation Category", 
       y = "Nr of Observations that were Delayed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

In the next step, the delay counts are normalized by the total number of trains per category. As a result, the differences between the boxplots become much less pronounced

```{r Normalize for compariosn, include=TRUE}
# Count of observations per operation_category
category_counts <- d.poisson %>%
  filter(operation_category %in% c("Low Operation", "Normal Operation", "Rush Hour")) %>%
  group_by(operation_category) %>%
  summarise(count = n())

category_counts

# Merge the count per operation_category with the dataframe
d.poisson.agg.day.oc <- d.poisson.agg.day.oc %>%
  left_join(category_counts, by = "operation_category") %>%
  mutate(Count_Delayed_Norm = Count_Delayed / count)  # Normalization step

ggplot(d.poisson.agg.day.oc, aes(x = operation_category, 
                                 y = Count_Delayed_Norm)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, height = 0.01, color = "blue", alpha = 0.2) +
  labs(title = "Normalized Delayed Trains Count", 
       x = "Operation Category", 
       y = "Normalized Nr of Observations that were Delayed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```



We now perform an ANOVA followed by multiple comparison testing to statistically assess the differences observed in the boxplot.

 - ANOVA confirms that there is a statistically significant difference between at least one of the three operation categories.

 - The multiple comparison test reveals that not all pairwise differences are significant. While 'Low Operation' differs significantly from both 'Normal Operation' and 'Rush Hour', the difference between 'Normal Operation' and 'Rush Hour' is not statistically significant.

This supports our earlier observation from the boxplot and confirms that the predictor is overall significant, though not all categories differ from each other




```{r GLM Poisson: Influence Operation Category, include=TRUE}
library(multcomp)
d.poisson.agg.day.oc$operation_category <- as.factor(d.poisson.agg.day.oc$operation_category)
anova_model <- aov(Count_Delayed_Norm ~operation_category, data = d.poisson.agg.day.oc)
summary(anova_model)  # Overall ANOVA table

mc <- glht(anova_model, linfct = mcp(operation_category = "Tukey"))
summary(mc)
```
To conclude, the analysis has revealed a valuable predictor that will be utilized in the subsequent modeling phase


## Finding reasonable Predictors "Event Category"

Creating a level for each Day in November does not make sense. Therefore data are again visualized to see if there are any patterns so that
predictor can be simplified. In the boxplot there are 22 observation per "operation day". One obsevation per operating hour.

The boxplot proposes a separtion into the following 3 Levels:

-  Extreme Days: 22.11 and 23.11
-  Meiringen Reopened : After 25.11
-  Normal Operation


```{r Look at Days, include=TRUE}

ggplot(mapping = aes(y = d.poisson.agg.day.oh$Count_Delayed,
x = d.poisson.agg.day.oh$BETRIEBSTAG)) +
  geom_boxplot() + 
  geom_hline(yintercept = 0) + 
  geom_jitter(width = 0.5, height = 0.3, color = "blue", alpha = 0.2)+
  labs(title = "Delayed Trains Count", 
       x = "Operating Hour", 
       y = "Simulated Observations that were Delayed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

In the boxplot below a direct comparison of delayed train counts across operation categories isn't meaningful, since each category includes a different total number of train arrivals.

```{r Add Day Category, include=TRUE}

d.poisson <- d.poisson %>%
  mutate(
    day_category = case_when(
      (BETRIEBSTAG == "2024-11-21") |
      (BETRIEBSTAG == "2024-11-22") ~ "Extreme Days",   
      (as.Date(BETRIEBSTAG) >= "2024-11-25")  ~ "Meiringen Reopened", # 4pm to 8pm
      TRUE ~ "Normal Operation"   # Everything else
    )
  )

#Create A subset aggregating by operation day and day category
d.poisson.agg.day.dc <- d.poisson %>%
  filter(!is.na(operating_hour)) %>%  # Removes NA observations --> This are the Abfahrtszüge
  group_by(day_category,operating_hour) %>%
  summarize(Count_Delayed = sum(Delay_Category != "On Time"), .groups = "drop") %>% 
  ungroup()  # Ungroup after mutation


ggplot(d.poisson.agg.day.dc, aes(x = day_category , 
                           y = Count_Delayed)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, height = 0.01, color = "blue", alpha = 0.2)
  labs(title = "Delayed Trains Count", 
       x = "Operation Category", 
       y = "Nr of Observations that were Delayed per Day") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


In the next step, the delay counts are normalized by the total number of trains per category

```{r Normalize for comparison 2, include=TRUE}
# Count of observations per operation_category
category_counts <- d.poisson %>%
  filter(day_category %in% c("Extreme Days", "Meiringen Reopened", "Normal Operation")) %>%
  group_by(day_category) %>%
  summarise(count = n())

category_counts

# Merge the count per operation_category with the dataframe
d.poisson.agg.day.dc <- d.poisson.agg.day.dc %>%
  left_join(category_counts, by = "day_category") %>%
  mutate(Count_Delayed_Norm = Count_Delayed / count)  # Normalization step

ggplot(d.poisson.agg.day.dc, aes(x = day_category, 
                                 y = Count_Delayed_Norm)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, height = 0.01, color = "blue", alpha = 0.2) +
  labs(title = "Normalized Delayed Trains Count", 
       x = "Operation Category", 
       y = "Normalized Nr of Observations that were Delayed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
To statistically assess the differences observed in the boxplot, we conduct an ANOVA followed by multiple comparison testing.

 - The ANOVA confirms that there is a statistically significant difference between at least one of the three day categories.

 - The multiple comparison test further reveals that all pairwise differences between the categories are statistically significant.

This indicates that day_category is a strong predictor and will be considered for inclusion in the modeling process.

```{r GLM Poisson: Influence Day Category, include=TRUE}
library(multcomp)
d.poisson.agg.day.dc$day_category <- as.factor(d.poisson.agg.day.dc$day_category)
anova_model <- aov(Count_Delayed_Norm ~day_category, data = d.poisson.agg.day.dc)
summary(anova_model)  # Overall ANOVA table

mc <- glht(anova_model, linfct = mcp(day_category = "Tukey"))
summary(mc)
```
