---
title: "GLM Poisson"
subtitle: "[Public GitHub Repository](https://github.com/paACode/publictransport_winterbottlenecks_palest)"
author:  "Pascal"
date: "27.03.2025"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
  pdf_document:
    toc: true
    toc_depth: '3'
---


```{r, echo=FALSE , include=FALSE}
## Document related Settings and Libs
require(knitr) 
require(details)    # allows collapsible code blocks
require(gt)         # formats tables nicely

## general language settings
Sys.setenv(LANG = "en")

## Default Settings for R-Chunks
opts_chunk$set(echo = FALSE ,
               include = FALSE,
               comment = NA,
               eval = TRUE,
               message = FALSE,
               warning = FALSE)
```


# Ideas for GLM Poisson

For the GLM (Poisson) there is a Response Variable needed which is count data.
As there are none present in the dataset an ideas was to use the the binary varibale
FEALLT_AUS_TF and count observations where there was a cancellation of the connection


```{r Import and Filter Data  }

library(dplyr)
library(ggplot2)
library(tidyr)
library(forcats) 
library(lubridate)

#### Read in Data ####----------------------------------------------------------
d.zentrahlbahn<- read.csv("zentrahlbahn_final.csv") %>% 
  select(BETRIEBSTAG, LINIEN_TEXT, HALTESTELLEN_NAME, ANKUNFTSZEIT, AN_PROGNOSE,
         ANKUNFTDELAY_sec, ABFAHRTSZEIT, AB_PROGNOSE, ABFAHRTDELAY_sec,
         FAELLT_AUS_TF,  # Suggestion to use as Response Variable
         Delay_Category, TAGESZEIT, RUSH_HOUR, w_precip_mm_Luzern, w_temp_min_c_Luzern, w_temp_avg_c_Luzern)

```

In this first plot it looks like that the Train Stop could be a good predictor.
The 14 Stations that have a much bigger delay are the ones which come after Meiringen.
This is related to the natural disaster in Brienz,


```{r Relation between Train Stop and Cancellations per Day, include=TRUE}

### Make a Boxplot to see relation between Haltestelle AUSFEALLE PER DAY

d.zentrahlbahn <- d.zentrahlbahn %>%
  group_by(HALTESTELLEN_NAME, BETRIEBSTAG) %>%
  mutate(
    AUSFAELLE_PER_DAY = sum(FAELLT_AUS_TF),  # Count TRUE values of FEALLT_AUS per station
    ) %>%
  ungroup()


ggplot(d.zentrahlbahn, aes(x =  fct_reorder(HALTESTELLEN_NAME, 
                                            AUSFAELLE_PER_DAY,
                                            median, na.rm = TRUE), 
                           y = AUSFAELLE_PER_DAY)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(title = "Distribution of Failures per Day by Station", 
       x = "Station", 
       y = "Number of Failures (AUSFAELLE_PER_DAY)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


This are the Lines R70 and R71. So one easy predictor for AUSFAELLE is if the observation is on the blocked line or not.

```{r Relation between Train Line and Cancellations per Day, include=TRUE}

### Make a Boxplot to see relation between Haltestelle AUSFEALLE PER DAY

d.zentrahlbahn <- d.zentrahlbahn %>%
  group_by(LINIEN_TEXT, BETRIEBSTAG) %>%
  mutate(
    AUSFAELLE_PER_DAY = sum(FAELLT_AUS_TF),  # Count TRUE values of FEALLT_AUS per station
  ) %>%
  ungroup()


ggplot(d.zentrahlbahn, aes(x =  fct_reorder(LINIEN_TEXT, 
                                            AUSFAELLE_PER_DAY,
                                            median, na.rm = TRUE), 
                           y = AUSFAELLE_PER_DAY)) +
  geom_boxplot() +
  scale_y_log10() +
  labs(title = "Distribution of Failures per Day by Station", 
       x = "Station", 
       y = "Number of Failures (AUSFAELLE_PER_DAY)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


The problem about the plost above is that the AUSFEALLE per Day are in most cases the same for all 30 days. So there is not really a distribution in the Ausfälle counts


A much better idea to make a GLM with poisson would be to count how many trains are "delayed" per hour during the day. The counts would be for each trainstation


What we see in the following plot are all the observations that were on time. Each point is a day in November ( total 30 per operating hour)

```{r on time trains, include=TRUE}

### First of all we add a categorical variable for every hour per day --> in total 24 categories

d.zentrahlbahn <-  d.zentrahlbahn %>% 
  mutate(
    hour = hour(as.POSIXct(ANKUNFTSZEIT, format="%Y-%m-%d %H:%M:%S")), 
    operating_hour = factor(
      paste0(hour, ":00 - ", hour + 1, ":00"),
      levels = paste0(0:23, ":00 - ", 1:24, ":00")
    )
  )


#Now we count all the oservations that were on time  for each operation hour --> 30 observations per day
d.zentrahlbahn_summary <- d.zentrahlbahn %>%
  group_by(operating_hour, BETRIEBSTAG) %>%
  summarize(Count_ON_TIME = sum(Delay_Category == "On Time"), .groups = "drop") %>% 
  ungroup()


ggplot(d.zentrahlbahn_summary, aes(x =  operating_hour, 
                           y = Count_ON_TIME)) +
  geom_boxplot() +
   geom_jitter(width = 0.2, height = 0.1, color = "blue", alpha = 0.2)+
  labs(title = "On Time Trains Count", 
       x = "Operating Hour", 
       y = "Nr of Observations that were on Time") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



```

More valuable insight would be to know the perecentage of trains that were on time. Therefore we divide for each hour by the number of oservations that are available. But this does not work, because poisson need count data.


```{r On time trains  nr of trains hh, include=TRUE}



#Now we count all the oservations that were on time  for each operation hour --> 30 observations per day
d.zentrahlbahn_summary <- d.zentrahlbahn %>%
  group_by(operating_hour, BETRIEBSTAG) %>%
  summarize(
    Count_ON_TIME = sum(Delay_Category == "On Time"),
    Total_Trains = n(),  # Total number of trains in this hour
    .groups = "drop"
  ) %>%
  mutate(Proportion_On_Time = Count_ON_TIME / Total_Trains)


ggplot(d.zentrahlbahn_summary, aes(x =  operating_hour, 
                           y = Proportion_On_Time)) +
  geom_boxplot() +
   geom_jitter(width = 0.2, height = 0.1, color = "blue", alpha = 0.2)+
  labs(title = "On Time Trains Count", 
       x = "Operating Hour", 
       y = "Nr of Observations that were on Time") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



```
Lets now have a look at the plot of delays Trains.



```{r delayed trains, include=TRUE}


#Now we count all the oservations that were on time  for each operation hour --> 30 observations per day
d.zentrahlbahn_summary <- d.zentrahlbahn %>%
  filter(!is.na(operating_hour)) %>%  # Removes NA observations --> This are the Abfahrtszüge
  group_by(operating_hour, BETRIEBSTAG) %>%
  summarize(Count_Delayed = sum(Delay_Category != "On Time"), .groups = "drop") %>% 
  ungroup()


ggplot(d.zentrahlbahn_summary, aes(x =  operating_hour, 
                           y = Count_Delayed)) +
  geom_boxplot() +
   geom_jitter(width = 0.2, height = 0.1, color = "blue", alpha = 0.2)+
  labs(title = "Delayed Trains Count", 
       x = "Operating Hour", 
       y = "Nr of Observations that were Delayed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



```
An interesting model could be to classify the rush hours (in red)

Then we would habe 3  classes "Ruhs Hour", "No Operation" (von 4am to 5am), "Low Operation" (0am to 2am)
and "Mid Operation) everything in between.

Her ei could do some T-Test Analysis to see which Hours significantly differ




![Rush Hour Image](Rush_Hours.png)

Lets create the rush hour categories and we see that this will give a great GLM poisson model.  But we also should see this in proportion

```{r Rush Hour Category, include=TRUE}


d.zentrahlbahn <- d.zentrahlbahn %>%
  mutate(
    ANKUNFTSZEIT = as.POSIXct(ANKUNFTSZEIT, format="%Y-%m-%d %H:%M:%S"),
    rush_hour_category = case_when(
      hour(ANKUNFTSZEIT) >= 0 & hour(ANKUNFTSZEIT) < 2 ~ "Low Operation",   # 0am to 2am
      hour(ANKUNFTSZEIT) >= 4 & hour(ANKUNFTSZEIT) < 5 ~ "No Operation",    # 4am to 5am
      (hour(ANKUNFTSZEIT) >= 6 & hour(ANKUNFTSZEIT) < 9) |  # 6am to 9am
        (hour(ANKUNFTSZEIT) >= 11 & hour(ANKUNFTSZEIT) < 14) | # 11am to 2pm
        (hour(ANKUNFTSZEIT) >= 16 & hour(ANKUNFTSZEIT) < 20) ~ "Rush Hour", # 4pm to 8pm
      TRUE ~ "Normal Operation"   # Everything else
    )
  )

d.zentrahlbahn_summary <- d.zentrahlbahn %>%
  filter(!is.na(operating_hour)) %>%  # Removes NA observations --> This are the Abfahrtszüge
  group_by(rush_hour_category, BETRIEBSTAG) %>%
  summarize(Count_Delayed = sum(Delay_Category != "On Time"), .groups = "drop") %>% 
  ungroup()


ggplot(d.zentrahlbahn_summary, aes(x =  rush_hour_category, 
                           y = Count_Delayed)) +
  geom_boxplot() +
   geom_jitter(width = 0.2, height = 0.01, color = "blue", alpha = 0.2)+
  labs(title = "Delayed Trains Count", 
       x = "Operating Hour", 
       y = "Nr of Observations that were Delayed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



```
Just for interest we set it again into proportion. It is strange that there are negatuve Observations. The reason for that is that we jitter also in Y-Axis 

```{r Rush Hour Category¨in Proportion, include=TRUE}

d.zentrahlbahn_summary <- d.zentrahlbahn %>%
  filter(!is.na(operating_hour)) %>%  # Remove NA observations
  group_by(rush_hour_category, BETRIEBSTAG) %>%
  summarize(
    Count_Delayed = sum(Delay_Category != "On Time"),  # Count of delayed trains
    Total_Observations = n(),  # Total observations per group
    .groups = "drop"
  ) %>%
  ungroup() %>%
  mutate(
    Proportion_Delayed = Count_Delayed / Total_Observations  # Calculate proportion of delayed trains
  )

# Plot the proportion of delayed trains
ggplot(d.zentrahlbahn_summary, aes(x = rush_hour_category, 
                                   y = Proportion_Delayed)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, height = 0.01, color = "blue", alpha = 0.2) +
  labs(title = "Proportion of Delayed Trains", 
       x = "Rush Hour Category", 
       y = "Proportion of Observations that were Delayed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

Conlcusion of today: 

- We can make a Model which depends on operating hours ... we can detect which working hours do have a significant effect and add them
to our model

- We can make an easier Model Based on the Operation Class

# Start of Poisson Analysis

```{r Prepare Data for Poisson, include=FALSE}

d.delayed_trains <- d.zentrahlbahn %>%
  filter(!is.na(operating_hour)) %>%  # Removes NA observations --> This are the Abfahrtszüge
  group_by(operating_hour, BETRIEBSTAG) %>%
  summarize(Count_Delayed = sum(Delay_Category != "On Time"), .groups = "drop") %>% 
  ungroup()

```

A first look at the data shows that the data are right skewed. When we log transform it, the data looks normally distributed

```{r Prepare Data for Poisson, include=TRUE}
hist(d.delayed_trains$Count_Delayed, breaks = 20)
hist(log1p(d.delayed_trains$Count_Delayed), breaks=20)

```

Simulating a first GLM Poisson model that tries to predict the delay count per day, dependent on the working hour is simulated here. What is interesting is that the outliers are not present
in the simulated data. This could explain that there is other influences we do not track.

```{r GLM Poisson: Influence of Operating Hour, include=TRUE}
library(ggplot2)
glm.delay_count <- glm(Count_Delayed ~ operating_hour,
family = "poisson", data = d.delayed_trains)



#We do some simulation of this model
set.seed(12) 

sim.data.delay_count <- simulate(glm.delay_count)

ggplot(mapping = aes(y = sim.data.delay_count$sim_1,
x = d.delayed_trains$operating_hour)) +
  geom_boxplot() + 
  geom_hline(yintercept = 0) + 
  geom_jitter(width = 0.2, height = 0.1, color = "blue", alpha = 0.2)+
  labs(title = "Delayed Trains Count", 
       x = "Operating Hour", 
       y = "Simulated Observations that were Delayed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
Having a look if there are specific days in November . It looks like there is the 21. November and 22. November having way bigger  delays. But what is even much more interesting is that
from 25. November on the delays are in average smaller.

```{r Look at Days, include=TRUE}

ggplot(mapping = aes(y = d.delayed_trains$Count_Delayed,
x = d.delayed_trains$BETRIEBSTAG)) +
  geom_boxplot() + 
  geom_hline(yintercept = 0) + 
  geom_jitter(width = 0.2, height = 0.1, color = "blue", alpha = 0.2)+
  labs(title = "Delayed Trains Count", 
       x = "Operating Hour", 
       y = "Simulated Observations that were Delayed") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```
So we try a more refined model again: MAybe need to use quasipoissson! Need to discuss.

We have so many different levels. so maybe it makes sense to group the levels to make the model a bit easier. For this we use Multiple Comparison --> unfortunately i cannot make it rnu because i get a precision error


```{r Look at Days, include=TRUE}
#Need to have Predictors as Factor forlater Multiple comparison
d.delayed_trains$BETRIEBSTAG <-  as.factor(d.delayed_trains$BETRIEBSTAG)
d.delayed_trains$operating_hour <-  as.factor(d.delayed_trains$operating_hour)

glm.delay_count <- glm(Count_Delayed ~ operating_hour + BETRIEBSTAG,
family = "quasipoisson", data = d.delayed_trains)

#drop1(glm.delay_count,test = "F")


require(multcomp)
glht.1 <-  glht(glm.delay_count, linfct = mcp(operating_hour = "Tukey"))

glht.1


```


